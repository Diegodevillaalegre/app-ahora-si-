<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Activos Comunitarios - San Javier</title>
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

  <!-- Mapbox Geocoder -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" />

  <!-- Firebase App (compatibilidad) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <!-- Firebase Firestore (compatibilidad) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Estilos -->
  <style>
    /* Estilos generales */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f2f5;
      color: #333;
    }

    h1 {
      margin-top: 20px;
      font-size: 2em;
      color: #2c3e50;
    }

    /* Contenedor principal */
    .container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Estilos del mapa */
    #map {
      width: 100%;
      height: 500px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Contenedor de entrada */
    .input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      position: relative;
    }

    /* Botones */
    button {
      padding: 10px 20px;
      border: none;
      background-color: #3498db;
      color: white;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    #manual-button {
      background-color: #e67e22;
    }

    #manual-button:hover {
      background-color: #d35400;
    }

    /* Estilos del geocoder */
    .mapboxgl-ctrl-geocoder {
      min-width: 300px;
      max-width: 100%;
    }

    /* Estilos del contenedor de activos cercanos */
    #activos-cercanos {
      width: 100%;
      max-width: 800px;
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #activos-cercanos h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .activo-item {
      border-bottom: 1px solid #ecf0f1;
      padding: 10px 0;
    }

    .activo-item:last-child {
      border-bottom: none;
    }

    .activo-item h4 {
      margin: 0 0 5px 0;
      color: #16a085;
    }

    .activo-item ul {
      margin: 0;
      padding-left: 20px;
    }

    /* Estilos para la ventana modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      padding-top: 60px;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto; padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
    }

    .close {
      color: #aaa; float: right;
      font-size: 28px; font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black; text-decoration: none; cursor: pointer;
    }

    .modal input, .modal button {
      margin-top: 10px;
    }

    .modal input {
      width: calc(100% - 22px);
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      font-size: 1em;
    }

    .modal button {
      padding: 10px 20px;
      border: none;
      background-color: #27ae60;
      color: white;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .modal button:hover {
      background-color: #229954;
    }

    #listaActivos .activo-item {
      border-bottom: 1px solid #ecf0f1;
      padding: 10px 0;
    }

    #listaActivos .activo-item:last-child {
      border-bottom: none;
    }

    #listaActivos button {
      margin-top: 10px;
      background-color: #e74c3c;
      transition: background-color 0.3s;
    }

    #listaActivos button:hover {
      background-color: #c0392b;
    }

    /* Footer */
    .footer {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #bdc3c7;
      text-align: center;
      width: 100%;
      background-color: #ecf0f1;
    }

    .footer p {
      margin: 0;
      color: #7f8c8d;
    }

    /* Separador */
    .separador {
      margin: 20px 0;
      border-top: 2px solid #bdc3c7;
      width: 80%;
    }

    /* Media Queries para dispositivos móviles */
    @media (max-width: 600px) {
      #map {
        height: 300px;
      }

      .modal-content {
        width: 95%;
      }
    }
  </style>
</head>
<body>

  <h1>Activos Comunitarios en San Javier</h1>

  <div class="container">
    <div class="input-container">
      <!-- Contenedor del geocoder de Mapbox -->
      <div id="geocoder" style="width: 100%; max-width: 500px;"></div>
      <div>
        <button id="manual-button" onclick="activarModoManual()">Ubicación Manual</button>
      </div>
    </div>

    <div id="map"></div>

    <div id="activos-cercanos">
      <h3>Activos Comunitarios Cercanos</h3>
      <div id="activos-lista"></div>
    </div>

    <button onclick="iniciarSesion()">Agregar Activos Comunitarios</button>
  </div>

  <!-- Ventana Modal para la gestión de activos -->
  <div id="modalGestionActivos" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h2>Gestión de Activos Comunitarios</h2>
      <button onclick="mostrarFormularioAgregar()">Agregar Nuevo Activo</button>
      <div id="formularioAgregar" style="display:none; margin-top:20px;">
        <input type="text" id="nuevoNombre" placeholder="Nombre del activo">
        <input type="text" id="nuevasActividades" placeholder="Actividades (separadas por coma)">
        <input type="text" id="nuevasCoordenadas" placeholder="Coordenadas (lng,lat)">
        <button onclick="agregarActivo()">Guardar</button>
      </div>
      <div id="listaActivos" style="margin-top:20px;"></div>
    </div>
  </div>

  <!-- Ventana Modal para el inicio de sesión -->
  <div id="modalLogin" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close" onclick="cerrarModalLogin()">&times;</span>
      <h2>Iniciar Sesión</h2>
      <input type="text" id="usuario" placeholder="Usuario">
      <input type="password" id="contrasena" placeholder="Contraseña">
      <button onclick="verificarCredenciales()">Ingresar</button>
    </div>
  </div>

  <div class="separador"></div>

  <div class="footer">
    <p>Elaborado por Diego Ortega Araya con la ayuda de ChatGPT</p>
  </div>

  <script>
   mapboxgl.accessToken = 'pk.eyJ1IjoiZGllZ29vcnRlZ2FhcmF5YSIsImEiOiJjbHlzd2lqaWQwbWhyMmlwd25teHQwNGRpIn0.KUEqCflKyq3bKhlDzRkWbw';

    var map;
    var marcadorUsuario = null;
    var activosMarkers = [];
    var modoManual = false;
    var geocoder;
    var autocomplete;

    // Inicializar Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA_E4MVXqVGFwNXyc9hKTBULbq-kl2LhRo",
      authDomain: "activos-final.firebaseapp.com",
      databaseURL: "https://activos-final-default-rtdb.firebaseio.com",
      projectId: "activos-final",
      storageBucket: "activos-final.appspot.com",
      messagingSenderId: "157184114938",
      appId: "1:157184114938:web:5d00e1f38792aea2c24943",
      measurementId: "G-6DHSMNVGZ0"
    };

    // Inicializa la aplicación de Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", function() {
      // Inicializar el mapa
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-71.73888, -35.59534], // Coordenadas de San Javier
        zoom: 14
      });

      // Agregar controles de navegación al mapa
      map.addControl(new mapboxgl.NavigationControl());

      // Definir la bounding box para San Javier
      // [minLng, minLat, maxLng, maxLat]
      var bboxSanJavier = [-71.8000, -35.6500, -71.6800, -35.5500];

      // Inicializar el geocoder de Mapbox
      var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        countries: 'cl',
        placeholder: 'Ingresa una dirección en San Javier',
        bbox: bboxSanJavier, // Restringir búsquedas a San Javier
        mapboxgl: mapboxgl,
        proximity: {
          longitude: -71.73888,
          latitude: -35.59534
        },
        types: 'address', // Limitar a direcciones
        filter: function(item) {
          // Opcional: Filtrar resultados que estén dentro de San Javier
          var lng = item.center[0];
          var lat = item.center[1];
          return (lng >= bboxSanJavier[0] && lng <= bboxSanJavier[2] &&
                  lat >= bboxSanJavier[1] && lat <= bboxSanJavier[3]);
        }
      });

      document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

      // Evento cuando se selecciona una ubicación
      geocoder.on('result', function(e) {
        var coords = e.result.center;
        colocarMarcadorUsuario(coords);
        map.flyTo({ center: coords, zoom: 15 });
        mostrarActivosCercanos(coords);
      });

      // Cargar todos los activos en el mapa al iniciar
      cargarActivosEnMapa();
    });

    function colocarMarcadorUsuario(coords) {
      // Eliminar PIN del usuario anterior
      if (marcadorUsuario) {
        marcadorUsuario.remove();
      }

      // Añadir nuevo PIN del usuario
      marcadorUsuario = new mapboxgl.Marker({ color: 'red' })
        .setLngLat(coords)
        .addTo(map);
    }

    function cargarActivosEnMapa() {
      // Limpiar los marcadores anteriores de activos comunitarios
      activosMarkers.forEach(marker => marker.remove());
      activosMarkers = [];

      // Obtener los activos comunitarios desde Firebase
      db.collection('activosComunitarios').onSnapshot((querySnapshot) => {
        // Limpiar marcadores anteriores
        activosMarkers.forEach(marker => marker.remove());
        activosMarkers = [];

        querySnapshot.forEach((doc) => {
          const activo = doc.data();
          const marker = new mapboxgl.Marker({ color: 'blue' })
            .setLngLat(activo.coords)
            .setPopup(new mapboxgl.Popup().setHTML(`
              <h3>${activo.nombre}</h3>
              <p>Actividades:</p>
              <ul>${activo.actividades.map(act => `<li>${act}</li>`).join('')}</ul>
            `))
            .addTo(map);
          activosMarkers.push(marker);
        });
      });
    }

    function mostrarActivosCercanos(coords) {
      // Limpiar los marcadores de activos comunitarios cercanos
      activosMarkers.forEach(marker => marker.remove());
      activosMarkers = [];

      // Obtener los activos comunitarios desde Firebase
      db.collection('activosComunitarios').get().then((querySnapshot) => {
        let activosCercanos = [];
        querySnapshot.forEach((doc) => {
          let activo = doc.data();
          if (activo.coords) {
            activo.distancia = calcularDistancia(coords[1], coords[0], activo.coords[1], activo.coords[0]);
            activosCercanos.push({ ...activo, id: doc.id });
          }
        });

        // Ordenar los activos por distancia y seleccionar los 3 más cercanos
        activosCercanos.sort((a, b) => a.distancia - b.distancia);
        activosCercanos = activosCercanos.slice(0, 3);

        // Actualizar lista de activos en la interfaz
        var activosLista = document.getElementById('activos-lista');
        activosLista.innerHTML = '';
        activosCercanos.forEach(activo => {
          var div = document.createElement('div');
          div.className = 'activo-item';
          div.innerHTML = `<h4>${activo.nombre}</h4><ul>${activo.actividades.map(act => `<li>${act}</li>`).join('')}</ul>`;
          activosLista.appendChild(div);

          var marker = new mapboxgl.Marker({ color: 'blue' })
            .setLngLat(activo.coords)
            .setPopup(new mapboxgl.Popup().setHTML(`
              <h3>${activo.nombre}</h3>
              <p>Actividades sugeridas:</p>
              <ul>${activo.actividades.map(act => `<li>${act}</li>`).join('')}</ul>
            `))
            .addTo(map);
          activosMarkers.push(marker);
        });
      }).catch(error => {
        console.error('Error al obtener activos cercanos:', error);
        alert('Ocurrió un error al obtener los activos cercanos.');
      });
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        0.5 - Math.cos(dLat)/2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        (1 - Math.cos(dLon)) / 2;
      return R * 2 * Math.asin(Math.sqrt(a));
    }

    function activarModoManual() {
      modoManual = !modoManual;
      if (modoManual) {
        map.getCanvas().style.cursor = 'crosshair';
        map.on('click', colocarPinManual);
        alert('Modo de colocación manual activado. Haz clic en el mapa para colocar el PIN.');
      } else {
        map.getCanvas().style.cursor = '';
        map.off('click', colocarPinManual);
        alert('Modo de colocación manual desactivado.');
      }
    }

    function colocarPinManual(e) {
      var coords = [e.lngLat.lng, e.lngLat.lat];
      colocarMarcadorUsuario(coords);
      map.flyTo({ center: coords, zoom: 15 });
      mostrarActivosCercanos(coords);
    }

    // Funciones para la gestión de activos comunitarios
    function iniciarSesion() {
      document.getElementById('modalLogin').style.display = 'block';
    }

    function cerrarModalLogin() {
      document.getElementById('modalLogin').style.display = 'none';
    }

    function verificarCredenciales() {
      const usuario = document.getElementById('usuario').value;
      const contrasena = document.getElementById('contrasena').value;

      if (usuario === 'ECICEP' && contrasena === 'usuario') {
        cerrarModalLogin();
        abrirGestionActivos();
      } else {
        alert('Usuario o contraseña incorrectos.');
      }
    }

    function abrirGestionActivos() {
      document.getElementById('modalGestionActivos').style.display = 'block';
      cargarActivos();
    }

    function cerrarModal() {
      document.getElementById('modalGestionActivos').style.display = 'none';
      document.getElementById('formularioAgregar').style.display = 'none';
    }

    function mostrarFormularioAgregar() {
      document.getElementById('formularioAgregar').style.display = 'block';
    }

    function cargarActivos() {
      const listaActivos = document.getElementById('listaActivos');
      listaActivos.innerHTML = '';

      db.collection('activosComunitarios').onSnapshot((querySnapshot) => {
        listaActivos.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const activo = doc.data();
          const div = document.createElement('div');
          div.className = 'activo-item';
          div.innerHTML = `
            <h4>${activo.nombre}</h4>
            <p>Actividades: ${activo.actividades.join(', ')}</p>
            <p>Coordenadas: ${activo.coords.join(', ')}</p>
            <button onclick="eliminarActivo('${doc.id}')">Eliminar</button>
          `;
          listaActivos.appendChild(div);
        });
      });
    }

    function agregarActivo() {
      const nombre = document.getElementById('nuevoNombre').value;
      const actividades = document.getElementById('nuevasActividades').value.split(',').map(act => act.trim());
      const coordsInput = document.getElementById('nuevasCoordenadas').value;
      const coords = coordsInput.split(',').map(coord => parseFloat(coord.trim()));

      if (!nombre || actividades.length === 0 || coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
        alert('Por favor, completa todos los campos correctamente.');
        return;
      }

      db.collection('activosComunitarios').add({
        nombre: nombre,
        actividades: actividades,
        coords: coords
      }).then(() => {
        alert('Activo agregado exitosamente.');
        document.getElementById('nuevoNombre').value = '';
        document.getElementById('nuevasActividades').value = '';
        document.getElementById('nuevasCoordenadas').value = '';
        document.getElementById('formularioAgregar').style.display = 'none';
        // Actualizar marcadores en el mapa
        cargarActivosEnMapa();
      }).catch(error => {
        console.error('Error al agregar el activo:', error);
      });
    }

    function eliminarActivo(id) {
      if (confirm('¿Estás seguro de que deseas eliminar este activo?')) {
        db.collection('activosComunitarios').doc(id).delete().then(() => {
          alert('Activo eliminado exitosamente.');
          // Actualizar marcadores en el mapa
          cargarActivosEnMapa();
        }).catch(error => {
          console.error('Error al eliminar el activo:', error);
        });
      }
    }

    // Cerrar modales al hacer clic fuera de ellos
    window.onclick = function(event) {
      var modalGestion = document.getElementById('modalGestionActivos');
      var modalLogin = document.getElementById('modalLogin');
      if (event.target == modalGestion) {
        cerrarModal();
      }
      if (event.target == modalLogin) {
        cerrarModalLogin();
      }
    }
  </script>
</body>
</html>
