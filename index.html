<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Activos Comunitarios - San Javier</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
        }

        h1 {
            margin-top: 20px;
        }

        #map {
            width: 80%;
            height: 500px;
            margin: 20px 0;
            border: 2px solid #ccc;
            border-radius: 10px;
        }

        .input-container {
            display: flex;
            justify-content: center;
            margin: 20px;
            position: relative;
        }

        input[type="text"] {
            width: 300px;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            background-color: #28a745;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }

        .suggestions {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000;
        }

        .suggestions div {
            padding: 10px;
            cursor: pointer;
        }

        .suggestions div:hover {
            background-color: #f1f1f1;
        }

        .footer {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #ccc;
            text-align: center;
            width: 100%;
        }

        .separador {
            margin: 20px 0;
            border-top: 2px solid #ccc;
            width: 80%;
        }

        #activos-cercanos {
            width: 80%;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }

        #activos-cercanos h3 {
            margin-top: 0;
        }

        #manual-button {
            margin-left: 10px;
            background-color: #007bff;
        }

        #manual-button:hover {
            background-color: #0056b3;
        }
	#agregar-activos-btn {
		position: fixed;
 	   bottom: 20px;
    right: 20px;
    padding: 10px 15px;
    border: none;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
}

#agregar-activos-btn:hover {
    background-color: #0056b3;
}
#ventana-activos {
    position: fixed;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    background: white;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 1000;
}

#ventana-contenido {
    padding: 20px;
}
#lista-activos {
    max-height: 300px; /* Ajusta la altura según sea necesario */
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 5px;
}



    </style>
</head>
<body>

    <h1>Activos Comunitarios en San Javier</h1>

    <div class="input-container">
        <input type="text" id="direccion" placeholder="Ingresa una dirección en San Javier" oninput="mostrarSugerencias()">
        <button onclick="buscarDireccion()">Buscar</button>
        <button id="manual-button" onclick="activarModoManual()">Ubicación Manual</button>
        <div id="suggestions" class="suggestions"></div>
    </div>

    <div id="map"></div>

    <div id="activos-cercanos">
        <h3>Activos Comunitarios Cercanos</h3>
        <div id="activos-lista"></div>
    </div>

    <div class="separador"></div>

    <div id="activos-lista"></div>

    <div class="footer">
        <p>Elaborado por Diego Ortega Araya con la ayuda de ChatGPT</p>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGllZ29vcnRlZ2FhcmF5YSIsImEiOiJjbHlzd2lqaWQwbWhyMmlwd25teHQwNGRpIn0.KUEqCflKyq3bKhlDzRkWbw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-71.73888, -35.59534], // Coordenadas de San Javier
            zoom: 14
        });

        var marcadorUsuario = null;
        var activosMarkers = [];
        var modoManual = false;

        function buscarDireccion() {
            var direccion = document.getElementById('direccion').value;
            var url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(direccion)}.json?access_token=${mapboxgl.accessToken}&bbox=-71.794,-35.630,-71.670,-35.560&limit=1`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features.length > 0) {
                        var coords = data.features[0].geometry.coordinates;

                        // Eliminar PIN del usuario anterior
                        if (marcadorUsuario) {
                            marcadorUsuario.remove();
                        }

                        // Añadir nuevo PIN del usuario
                        marcadorUsuario = new mapboxgl.Marker({ color: 'red' })
                            .setLngLat(coords)
                            .addTo(map);

                        map.flyTo({ center: coords, zoom: 15 });

                        mostrarActivosCercanos(coords);
                    } else {
                        alert("Dirección no encontrada, por favor ingresa una dirección válida en San Javier.");
                    }
                })
                .catch(error => console.error('Error al buscar la dirección:', error));
        }

        function mostrarActivosCercanos(coords) {
            // Limpiar los marcadores anteriores de activos comunitarios
            activosMarkers.forEach(marker => marker.remove());
            activosMarkers = [];

            // Mostrar los 3 activos comunitarios más cercanos
            let activosCercanos = activosComunitarios.map(activo => ({
                ...activo,
                distancia: calcularDistancia(coords[1], coords[0], activo.coords[1], activo.coords[0])
            })).sort((a, b) => a.distancia - b.distancia).slice(0, 3);

            // Actualizar lista de activos en la interfaz
            var activosLista = document.getElementById('activos-lista');
            activosLista.innerHTML = '';
            activosCercanos.forEach(activo => {
                var div = document.createElement('div');
                div.innerHTML = `<h4>${activo.nombre}</h4><ul>${activo.actividades.map(act => `<li>${act}</li>`).join('')}</ul>`;
                activosLista.appendChild(div);

                var marker = new mapboxgl.Marker()
                    .setLngLat(activo.coords)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <h3>${activo.nombre}</h3>
                        <p>Actividades sugeridas:</p>
                        <ul>${activo.actividades.map(act => `<li>${act}</li>`).join('')}</ul>
                    `))
                    .addTo(map);
                activosMarkers.push(marker);
            });
        }

        function activarModoManual() {
            modoManual = !modoManual;
            if (modoManual) {
                map.getCanvas().style.cursor = 'crosshair';
                map.on('click', colocarPinManual);
                alert('Modo de colocación manual activado. Haz clic en el mapa para colocar el PIN.');
            } else {
                map.getCanvas().style.cursor = '';
                map.off('click', colocarPinManual);
                alert('Modo de colocación manual desactivado.');
            }
        }

        function colocarPinManual(e) {
            var coords = [e.lngLat.lng, e.lngLat.lat];

            // Eliminar PIN del usuario anterior
            if (marcadorUsuario) {
                marcadorUsuario.remove();
            }

            // Añadir nuevo PIN del usuario
            marcadorUsuario = new mapboxgl.Marker({ color: 'red' })
                .setLngLat(coords)
                .addTo(map);

            mostrarActivosCercanos(coords);
        }

        function mostrarSugerencias() {
            var input = document.getElementById('direccion');
            var suggestionsDiv = document.getElementById('suggestions');
            var direccion = input.value;
            var url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(direccion)}.json?access_token=${mapboxgl.accessToken}&bbox=-71.794,-35.630,-71.670,-35.560&limit=5`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = '';
                    if (data.features.length > 0) {
                        data.features.forEach(feature => {
                            var suggestionDiv = document.createElement('div');
                            suggestionDiv.textContent = feature.place_name;
                            suggestionDiv.onclick = function() {
                                input.value = feature.place_name;
                                suggestionsDiv.innerHTML = '';
                            };
                            suggestionsDiv.appendChild(suggestionDiv);
                        });
                    }
                })
                .catch(error => console.error('Error al buscar sugerencias:', error));
        }


        // Función para calcular la distancia entre dos coordenadas (Haversine formula)
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radio de la Tierra en km
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
var usuarioActual = null;
var claveActual = '1234';
	    <!-- Botón "Agregar Activos" -->
<button id="agregar-activos-btn" onclick="mostrarVentanaAgregarActivos()">Agregar Activos</button>

<!-- Ventana de Gestión de Activos -->
<div id="ventana-activos" style="display: none;">
    <div id="ventana-contenido">
        <h3>Gestión de Activos</h3>
        <form id="formulario-activos">
            <input type="hidden" id="activo-id">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" required><br>
            <label for="coordenadas">Coordenadas (Latitud, Longitud):</label>
            <input type="text" id="coordenadas" required><br>
            <label for="actividad1">Actividad 1:</label>
            <input type="text" id="actividad1"><br>
            <label for="actividad2">Actividad 2:</label>
            <input type="text" id="actividad2"><br>
            <label for="actividad3">Actividad 3:</label>
            <input type="text" id="actividad3"><br>
            <button type="button" onclick="guardarActivo()">Guardar Activo</button>
            <button type="button" onclick="ocultarVentana()">Cerrar</button>
        </form>
        <h4>Activos Actuales</h4>
        <div id="lista-activos"></div>
    </div>
</div>

function mostrarVentanaAgregarActivos() {
    if (!usuarioActual) {
        var usuario = prompt("Ingrese usuario:");
        var clave = prompt("Ingrese clave:");

        if (usuario === 'ADMIN' && clave === claveActual) {
            usuarioActual = usuario;
            mostrarVentana();
        } else {
            alert("Usuario o clave incorrectos.");
        }
    } else {
        mostrarVentana();
    }
}


function mostrarVentana() {
    document.getElementById('ventana-activos').style.display = 'block';
    actualizarListaActivos();
}

function ocultarVentana() {
    document.getElementById('ventana-activos').style.display = 'none';
    document.getElementById('formulario-activos').reset();
    activoEditando = null;
}


function mostrarVentanaCambioClave() {
    var nuevaClave = prompt("Ingrese nueva clave:");
    if (nuevaClave) {
        claveActual = nuevaClave;
        alert("Clave cambiada con éxito.");
    }
}

var activoEditando = null;

function guardarActivo() {
    var id = document.getElementById('activo-id').value; // Obtiene el ID del activo si existe
    var nombre = document.getElementById('nombre').value; 
    var coordenadas = document.getElementById('coordenadas').value.split(',').map(Number); // Convierte a números
    var actividades = [
        document.getElementById('actividad1').value,
        document.getElementById('actividad2').value,
        document.getElementById('actividad3').value
    ].filter(act => act); // Filtra para obtener solo las actividades no vacías

    var nuevoActivo = {
        nombre: nombre,
        coords: [coordenadas[1], coordenadas[0]], // Guarda como [Longitud, Latitud]
        actividades: actividades
    };

    if (id) {
        // Si hay un ID, se está editando un activo existente
        database.ref('activosComunitarios/' + id).update(nuevoActivo)
            .then(() => {
                alert("Activo actualizado.");
                ocultarVentana(); // Cierra la ventana después de guardar
                actualizarListaActivos(); // Actualiza la lista de activos
            })
            .catch((error) => {
                console.error("Error al actualizar el activo: ", error);
                alert("Hubo un problema al actualizar el activo.");
            });
    } else {
        // Si no hay un ID, se está creando un nuevo activo
        database.ref('activosComunitarios').push(nuevoActivo)
            .then(() => {
                alert("Activo guardado.");
                ocultarVentana(); // Cierra la ventana después de guardar
                actualizarListaActivos(); // Actualiza la lista de activos
            })
            .catch((error) => {
                console.error("Error al guardar el activo: ", error);
                alert("Hubo un problema al guardar el activo.");
            });
    }
}

function actualizarListaActivos() {
    var listaActivos = document.getElementById('lista-activos'); // Asegúrate de que este ID coincide con el HTML
    listaActivos.innerHTML = ''; // Limpia la lista antes de llenarla

    // Accede a la base de datos y escucha los cambios en 'activosComunitarios'
    database.ref('activosComunitarios').on('value', function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            var activo = childSnapshot.val(); // Obtiene los datos de cada activo
            var div = document.createElement('div'); // Crea un nuevo elemento <div> para mostrar el activo
            div.innerHTML = `<strong>${activo.nombre}</strong><br>
                Latitud: ${activo.coords[1]}<br>
                Longitud: ${activo.coords[0]}<br>
                Actividades: ${activo.actividades.join(', ')}<br>
                <button onclick="editarActivo('${childSnapshot.key}')">Editar</button>
                <button onclick="eliminarActivo('${childSnapshot.key}')">Eliminar</button>`; // Agrega botones para editar y eliminar
            listaActivos.appendChild(div); // Añade el <div> a la lista
        });
    });
}

function eliminarActivo(key) {
    if (confirm("¿Estás seguro de que deseas eliminar este activo?")) {
        // Elimina el activo de la base de datos
        database.ref('activosComunitarios/' + key).remove()
            .then(() => {
                alert("Activo eliminado.");
                actualizarListaActivos(); // Actualiza la lista después de eliminar
            })
            .catch((error) => {
                console.error("Error al eliminar el activo: ", error);
                alert("Hubo un problema al eliminar el activo.");
            });
    }
}
</script>


</body>
</html>
